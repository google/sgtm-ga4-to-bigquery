___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
	"categories": ["ANALYTICS"],
  "displayName": "GA4 to BigQuery",
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "This tag template automatically writes GA4 events to BigQuery.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "measurementId",
    "displayName": "Measurement ID",
    "simpleValueType": true,
    "help": "Enter the measurement ID used in the events that should be written to BigQuery. Use \"*\" to match all measurement IDs.",
    "defaultValue": "*"
  },
  {
    "type": "TEXT",
    "name": "collectIp",
    "displayName": "Write IP Address to BigQuery",
    "simpleValueType": true,
    "help": "Check the box to include a user\u0027s IP address when writing GA4 data to BigQuery. Accepts either true or false as values.",
    "defaultValue": false
  },
  {
    "type": "GROUP",
    "name": "bqSettings",
    "displayName": "BigQuery Settings",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "projectId",
        "displayName": "Cloud Project ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "datasetId",
        "displayName": "BigQuery Dataset ID",
        "simpleValueType": true
      },
      {
        "type": "TEXT",
        "name": "tableId",
        "displayName": "BigQuery Table ID",
        "simpleValueType": true
      }
    ],
    "help": "All settings must be entered for event data to be written to BigQuery."
  }
]


___SANDBOXED_JS_FOR_SERVER___

/**
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

const JSON = require('JSON');
const log = require('logToConsole');
const BigQuery = require('BigQuery');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const isRequestMpv2 = require('isRequestMpv2');
const addEventCallback = require('addEventCallback');
const getRemoteAddress = require('getRemoteAddress');
const getRequestHeader = require('getRequestHeader');
const extractEventsFromMpv2 = require('extractEventsFromMpv2');
const getRequestQueryParameters = require('getRequestQueryParameters');
const getTimestampMillis = require('getTimestampMillis');
const getEventData = require('getEventData');
const parseUrl = require('parseUrl');

addEventCallback((containerId, eventData) => {
  let skipWrite = false;
  if (data.projectId == undefined) {
    log('Missing project ID.');
    skipWrite = true;
  }
  if (data.datasetId == undefined) {
    log('Missing dataset ID.');
    skipWrite = true;
  }
  if (data.tableId == undefined) {
    log('Missing table ID.');
    skipWrite = true;
  }

  if (!skipWrite) {
    // Check event is GA4
    if (isRequestMpv2()) {
      const rows = extractEventsFromMpv2();
      rows[0].event_timestamp = getTimestampMillis() / 1000;
      rows[0].event_params = [];
      rows[0].user_properties = [];
      rows[0].user_agent = getRequestHeader('user-agent');

      if (data.collectIp == 'true') {
        rows[0].ip_address = getRemoteAddress();
      }

      // Set BQ connection info
      const connectionInfo = {
        'projectId': data.projectId,
        'datasetId': data.datasetId,
        'tableId': data.tableId
      };

      const options = {
        'ignoreUnknownValues': true,
        'skipInvalidRows': false
      };

      let topLevelKeys = [
        'x-ga-measurement_id',
        'x-ga-gtm_version',
        'client_id',
        'language',
        'screen_resolution',
        'x-ga-request_count',
        'page_location',
        'ga_session_id',
        'ga_session_number',
        'x-ga-mp-seg',
        'page_title',
        'event_name',
        'x-ga-request_count',
        'x-ga-mp2-ir',
        'page_referrer',
        'value',
        'engagement_time_msec',
        'items'
      ];

      const marketingParams = [
        'gclid',
        'dclid',
        'gbraid',
        'wbraid',
        'gclsrc',
        '_gl'
      ];

      const paramObj = getRequestQueryParameters();
      for (const param in paramObj) {
        if (param.split('.').length > 1) {
          const prefix = param.split('.')[0];
          const keyString = param.split('.')[1];
          if (topLevelKeys.indexOf(keyString) == -1) {
            const value = paramObj[param];
            log('Value: ' + value);
            const obj = {
              'key': keyString,
              'value': {}
            };

            if (makeNumber(value)) {
              obj.value.float_value = makeNumber(value);
            } else if (makeString(value)) {
              obj.value.string_value = makeString(value);
            }

            if (prefix == 'ep' || prefix == 'epn') {
              rows[0].event_params.push(obj);
            } else if (prefix == 'up' || prefix == 'upn') {
              rows[0].user_properties.push(obj);
            }
          }
        }
      }

      for (let param in rows[0]) {
        let newParam = '';
        for (let i = 0; i < param.length; i++) {
          if (param[i] == '-') {
            newParam += '_';
          } else {
            newParam += param[i];
          }
        }
        newParam = newParam.replace('x_ga_', '');
        newParam = newParam.replace('mp2_', '');
        newParam = newParam.replace('utm_', '');
        rows[0][newParam] = rows[0][param];
      }
      rows[0].session_engagement = rows[0].seg;
      
      const pageLocation = parseUrl(getEventData('page_location'));
      if (pageLocation && pageLocation.searchParams) {
        rows[0].source = pageLocation.searchParams.utm_source;
        rows[0].medium = pageLocation.searchParams.utm_medium;
        rows[0].campaign = pageLocation.searchParams.utm_campaign;
      }
      
      if (rows[0].x_ga_measurement_id == data.measurementId ||
          data.measurementId == '*') {
        BigQuery.insert(connectionInfo, rows, options)
          .then((success) => {
            log('success');
          }, (e) => {
            log(JSON.stringify(e));
          });
      }
    }
  }
});

data.gtmOnSuccess();


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_metadata",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "page_location"
              }
            ]
          }
        },
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []
setup: ''


___NOTES___

Created on 5/19/2022, 11:46:16 AM


